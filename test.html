<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Buy Ticket</title>
  <script src="https://sdk.monnify.com/plugin/monnify.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .ticket-form {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #0D4777;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 18px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      background: #0D4777;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background: #093559;
    }
    .price-box {
      background: #D5F2E8;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 18px;
      font-weight: bold;
      text-align: center;
      color: #0D4777;
    }
  </style>
</head>
<body>
  <form class="ticket-form" id="ticketForm">
    <h2>ðŸŽŸ Buy Your Ticket</h2>

    <label for="ticketType">Ticket Type</label>
    <select id="ticketType" required>
      <option value="">-- Select --</option>
      <option value="regular">REGULAR - â‚¦5,000</option>
      <option value="vip">VIP - â‚¦50,000</option>
    </select>

    <label for="quantity">Quantity</label>
    <input type="number" id="quantity" value="1" min="1" required>

    
    <label for="firstname">First Name</label>
    <input type="text" id="firstname" required>

    <label for="lastname">Last Name</label>
    <input type="text" id="lastname" required>
<!-- 
    <label for="department">Department</label>
    <input type="text" id="department" required> -->

    <label for="email">Email</label>
    <input type="email" id="email" required>
    
    <label for="phone">Phone</label>
    <input type="text" id="phone" required>
    
    <div class="price-box" id="priceBox">Total Price: â‚¦0</div>
    <br />
    <button type="submit">Proceed to Pay</button>
  </form>

  <script>
    const ticketPrices = { regular: 5000, vip: 50000 };
    const ticketTypeEl = document.getElementById("ticketType");
    const quantityEl = document.getElementById("quantity");
    const priceBox = document.getElementById("priceBox");

    // Update displayed price dynamically
    function updatePrice() {
      let type = ticketTypeEl.value;
      let qty = parseInt(quantityEl.value || 1);
      if (type && ticketPrices[type]) {
        let total = ticketPrices[type] * qty;
        priceBox.textContent = `Total Price: â‚¦${total}`;
      } else {
        priceBox.textContent = "Total Price: â‚¦0";
      }
    }
    ticketTypeEl.addEventListener("change", updatePrice);
    quantityEl.addEventListener("input", updatePrice);

    document.getElementById("ticketForm").addEventListener("submit", async function(e){
      e.preventDefault();

      let ticketType = ticketTypeEl.value;
      let quantity = parseInt(quantityEl.value);
      let firstname = document.getElementById("firstname").value;
      let lastname = document.getElementById("lastname").value;
    //   let department = document.getElementById("department").value;
      let email = document.getElementById("email").value;
      let phone = document.getElementById("phone").value;

      try {
        // 1ï¸âƒ£ Create Ticket
        let ticketRes = await fetch("http://localhost:8080/api/create-ticket/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ticket_type: ticketType,
            quantity: quantity,
            totalPrice: ticketPrices[ticketType] * quantity
          })
        });

        let ticketData = await ticketRes.json();
        if (ticketData.status !== "success") {
          alert("Error creating ticket: " + JSON.stringify(ticketData));
          return;
        }
        let ticketId = ticketData.ticket_id;   // must be returned from backend
        let totalPrice = ticketData.total_price;

        // 2ï¸âƒ£ Add Contact
        let contactRes = await fetch(`http://localhost:8080/api/ticket/${ticketId}/contact/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            firstname,
            lastname,
            // department,
            email,
            phone
          })
        });

        let contactData = await contactRes.json();
        if (!contactData || contactData.error) {
          alert("Error saving contact: " + JSON.stringify(contactData));
          return;
        }

        // 3ï¸âƒ£ Initialize Payment
        let payRes = await fetch(`http://localhost:8080/api/ticket/initialize-payment/`, {
        // let payRes = await fetch(`http://localhost:8080/api/ticket/${ticketId}/initialize-payment/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ticket_id: ticketId,
            // local_reference: payData ? payData.reference : null,
            email: email
          })
        });

        let payData = await payRes.json();
        console.log(payData);
        if (payData.error) {
          alert("Error initializing payment: " + payData.error);
          console.error(payData);
          console.log("Payment initialization failed");
          return;
        }

        // 4ï¸âƒ£ Open Monnify Payment
       MonnifySDK.initialize({
          amount: Number(payData.amount), // ensure number
          currency: "NGN",
          reference: payData.reference, // unique per transaction
          customerFullName: payData.customerName,
          customerEmail: payData.customerEmail,
          customerPhone: payData.customerPhone || "08000000000",
          apiKey: "MK_TEST_VZ3SL4J3A5",   // must be PUBLIC KEY
          contractCode: "4216477966",
          paymentDescription: "Event Ticket Purchase",
          isTestMode: true,
          metadata: {
            ticket_id: ticketId,
            ticketType: ticketType,
            quantity: quantity,
          },
          onLoadStart: () => {
            console.log("Monnify popup loading...");
          },
          onLoadComplete: () => {
            console.log("Monnify popup loaded.");
          },
          onComplete: function(response) {
            console.log("Transaction completed: ", response);
            // here response.paymentReference is the correct one to use
          },
          onClose: function(data) {
            console.log("Payment closed: ", data);
          }
        });


      } catch (err) {
        console.error(err);
        alert("Something went wrong. Check console.");
      }
    });
  </script>
</body>
</html>
