<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://sdk.monnify.com/plugin/monnify.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TEDx - TAU</title>
  <!-- Bootstrap + Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="button.css" />

</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container-fluid px-4">

    <!-- Brand Logo + Text -->
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="./images/tau.png" alt="Logo" style="height: 40px; width: 100%;" class="me-2" />
    </a>

    <!-- Toggler for mobile -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Nav Links -->
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav ms-auto me-2">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        <li class="nav-item"><a class="nav-link" href="event.html">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="tedXticket.html">Tickets</a></li>
        <li class="nav-item"><a class="nav-link" href="volunteer.html">Volunteer</a></li>
      </ul>

      <!-- Icons + Button -->
      <div class="d-flex align-items-center gap-3">
        <!-- <i class="fas fa-th text-white fs-5"></i> -->
        <a class="btn get-ticket-btn" href="tedXticket.html">GET TICKET</a>
      </div>
    </div>
  </div>
</nav>

<!-- Hero Section -->
<section class="hero-section text-white text-center py-5">
  <div class="container mt-5 pt-4">
    <!-- Title -->
    <h1 class="fw-bold display-4">The Future of AI Trends &</h1>
    <h2 class="fw-bold display-5 mb-4">Innovations</h2>

    <!-- Date / Time -->
    <div class="mb-3 fs-5 fw-medium d-flex justify-content-center align-items-center flex-wrap gap-2">
      <span>March 03, 2025</span>
      <span class="dot-separator"></span>
      <span>11:00 AM ‚Äì 12:30 PM</span>
    </div>

    <!-- Location -->
    <div class="fs-5">
      <strong>Location:</strong> Innovation Stage, TechHub<br />
      Conference Center
    </div>
  </div>
</section>

<section class="event-section container-fluid py-5">
  <div class="row g-0 align-items-start justify-content-center">
    
    <!-- LEFT: Event Image & Description -->
    <div class="col-lg-7 col-md-10 mb-4 mb-lg-0">
      <img src="./images/news-3.png" class="img-fluid rounded" alt="Event Audience" />

      <div class="mt-4 px-2">
        <h2 class="fw-bold mb-3">About the Event?</h2>
        <p class="text-light fs-5">
          The Future of AI: Trends & Innovations is a premier conference bringing together AI pioneers,
          researchers, and industry leaders to explore cutting-edge developments, ethical challenges,
          and visionary trends shaping the future of artificial intelligence.
        </p>
      </div>
            <div class="mt-4 px-2">
        <h2 class="fw-bold mb-3">What to Expect?</h2>
        <p class="text-light fs-5">
            Keynote Sessions - Insights from AI visionaries on the latest breakthroughs
            Panel Discussions - Experts debate the impact of AI across industries
            Live Demonstrations - Experience AI in action with interactive showcases
            Workshops & Training - Hands-on sessions with AI tools and frameworks
            Networking Opportunities - Connect with AI enthusiasts, startups, and investors
        </p>
      </div>
            <div class="mt-4 px-2">
        <h2 class="fw-bold mb-3">Who Should Attend?</h2>
        <div class="d-flex gap-5">
            <ul class="text-light fs-5 list-unstyled">
                <li>AI & Tech Enthusiasts</li>
                <li>Data Scientists & Developers</li>
                <li>Business Leaders & Entrepreneurs</li>
                <li>nvestors & Innovators</li>
            </ul>
            <ul class="text-light fs-5 list-unstyled mx-auto">
                <li>Data Scientists & Developers</li>
                <li>Business Leaders & Entrepreneurs</li>
                <li>Investors & Innovators</li>
            </ul>
        </div>
      </div>
    </div>

<div class="ticket-panel">
  <h4>üéüÔ∏è Buy Your Ticket</h4>
  <form class="ticket-form" id="ticketForm" novalidate>
    <label for="ticketType">Ticket Type</label>
    <select id="ticketType" name="ticketType" required onchange="showTicketDescription()">
      <option value="" disabled selected>---  Select  ---</option>
      <option value="">---  Select  ---</option>
      <option value="standard">üéì Standard ‚Äì ‚Ç¶5,000</option>
      <option value="gold">üåü Gold ‚Äì ‚Ç¶10,000</option>
      <option value="premium">üöÄ Premium ‚Äì ‚Ç¶15,000</option>
      <option value="vip">üëë VIP ‚Äì ‚Ç¶30,000</option>
    </select>
    
    <h4 id="ticketDescription" style=" font-size:14px; color:#333;"></h4>

    <label for="quantity">Quantity</label>
    <input type="number" id="quantity" name="quantity" min="1" value="1" required disabled>

    <div class="name-row">
      <div>
        <label for="firstname">First Name</label>
        <input type="text" id="firstname" name="firstname" required>
      </div>
      <div>
        <label for="lastname">Last Name</label>
        <input type="text" id="lastname" name="lastname" required>
      </div>
    </div>

    <label for="email">Email</label>
    <input type="email" id="email" name="email" required>

    <label for="phone">Phone</label>
    <input type="tel" id="phone" name="phone" required>

    <div class="price-box" id="priceBox">Total Price: ‚Ç¶0</div>
    <div class="small" id="message"></div>


    <button type="submit" class="btn-primary" id="submitBtn">Proceed to Pay</button>
  </form>
</div>

        <!-- Pass Type -->
        <!-- <div class="form-control bg-transparent border-light text-white mb-3">
          Silver Pass
        </div> -->

        <!-- Price + Quantity
        <div class="d-flex justify-content-between align-items-center border border-light rounded p-3 text-white mb-4">
          <div>
            <div class="fs-5 fw-bold">$285.00</div>
            <div class="text-light small">Unlimited</div>
          </div>
          <div class="d-flex align-items-center gap-3">
            <button class="btn text-white fs-4 px-2">-</button>
            <span class="fs-5">1</span>
            <button class="btn text-white fs-4 px-2">+</button>
          </div>
        </div> -->

        <!-- Quantity & Total
        <div class="mb-3 text-white">
          <div><strong>Quantity:</strong> 01</div>
          <div><strong>Total Cost:</strong> $285.00</div>
        </div>

        -- Purchase Button -->
        <!-- <button class="btn btn-primary Purchase w-100 fw-bold py-2 mt-2">PURCHASE NOW</button> -->
      </div>
    </div>
  </div>
</section>

  <div class="container">
    <h2>Speakers</h2>
    <div class="row g-4 mt-3">
      <div class="col-md-6">
        <div class="speaker-img position-relative">
          <img src="https://images.unsplash.com/photo-1522071820081-009f0129c71c" alt="Linda Roberts" />
          <a href="#" class="link-icon" aria-label="Link to Linda Roberts profile">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
              <path d="M4.715 6.542a3.237 3.237 0 0 1 4.57-4.57l.829.828a.5.5 0 0 0 .707-.708l-.828-.829a4.237 4.237 0 0 0-6.001 6.001l1.528 1.528a.5.5 0 0 0 .707-.708L4.715 6.54zm6.121 2.915a3.237 3.237 0 0 1-4.57 4.57l-.829-.828a.5.5 0 0 0-.707.708l.828.829a4.237 4.237 0 0 0 6.001-6.001l-1.528-1.528a.5.5 0 0 0-.707.708l1.528 1.528z"/>
              <path d="M6.286 9.193a.5.5 0 0 0 0 .707l2.829 2.828a.5.5 0 0 0 .707 0l3.536-3.536a.5.5 0 0 0 0-.707L10.243 6.657a.5.5 0 0 0-.707 0l-3.25 3.25z"/>
            </svg>
          </a>
        </div>
        <h3 class="speaker-name"><span class="purple-dot">‚óè</span>Linda Roberts</h3>
        <p class="speaker-role">Senior Data Scientist, OpenAI</p>
      </div>

      <div class="col-md-6">
        <div class="speaker-img position-relative">
          <img src="https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91" alt="James Porter" />
          <a href="#" class="link-icon" aria-label="Link to James Porter profile">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
              <path d="M4.715 6.542a3.237 3.237 0 0 1 4.57-4.57l.829.828a.5.5 0 0 0 .707-.708l-.828-.829a4.237 4.237 0 0 0-6.001 6.001l1.528 1.528a.5.5 0 0 0 .707-.708L4.715 6.54zm6.121 2.915a3.237 3.237 0 0 1-4.57 4.57l-.829-.828a.5.5 0 0 0-.707.708l.828.829a4.237 4.237 0 0 0 6.001-6.001l-1.528-1.528a.5.5 0 0 0-.707.708l1.528 1.528z"/>
              <path d="M6.286 9.193a.5.5 0 0 0 0 .707l2.829 2.828a.5.5 0 0 0 .707 0l3.536-3.536a.5.5 0 0 0 0-.707L10.243 6.657a.5.5 0 0 0-.707 0l-3.25 3.25z"/>
            </svg>
          </a>
        </div>
        <h3 class="speaker-name"><span class="purple-dot">‚óè</span>James Porter</h3>
        <p class="speaker-role">Full-Stack Developer, CodeGen</p>
      </div>
    </div>

    <div class="event-overview mt-5">
      <h2>Event Overview</h2>
      <p>
        The Future of AI: Trends & Innovations is a premier conference bringing together AI pioneers, researchers, and industry leaders to explore cutting-edge advancements in artificial intelligence. Dive into the latest trends, ethical considerations, and transformative technologies shaping the future.
      </p>
      <p>
        Lorem Ipsum is a premier conference bringing together AI pioneers, researchers, and industry leaders to explore the cutting-edge advancements in artificial intelligence. It‚Äôs a place to learn, network, and inspire the future of technology.
      </p>
    </div>
      <button class="btn btn-primary custom-btn">ADD TO CALENDER</button>
  </div>


   <section class="event-info mt-3">
    <div class="container">
      <div class="row gy-4">
        <!-- Detail -->
        <div class="col-md-3">
          <h5 class="section-title">Detail</h5>
          <p><span class="info-label">COST:</span><br />$285.00</p>
          <p><span class="info-label">DATE:</span><br />March 17, 2025</p>
          <p><span class="info-label">TIME:</span><br />Monday, 11:00 AM ‚Äì 12:30 PM</p>
        </div>

        <!-- Organizer -->
        <div class="col-md-3">
          <h5 class="section-title">Organizer</h5>
          <p>Johnathan Swift</p>
          <p><span class="info-label">CONTACT:</span><br />+1-416-8241228</p>
          <p><span class="info-label">EMAIL:</span><br />info@email.com</p>
          <p>eventsponsors.com</p>
        </div>

        <!-- Venue -->
        <div class="col-md-3">
          <h5 class="section-title">Venue</h5>
          <p><span class="info-label">LOCATION:</span><br />Innovation Stage, TechHub Conference Center</p>
          <p><span class="info-label">CONTACT:</span><br />+1-416-8241228</p>
          <p><span class="info-label">EMAIL:</span><br />info@email.com</p>
        </div>

        <!-- Map -->
        <div class="col-md-3">
          <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3021.937592356669!2d-74.45753938459347!3d40.871933479299744!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x89c2e7fbbcfb1563%3A0xa17d0a8a3b2d78a9!2sTroy%20Meadows%20Nature%20Preserve!5e0!3m2!1sen!2sus!4v1689528206123!5m2!1sen!2sus"
            allowfullscreen=""
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            title="Troy Meadows Nature Preserve Map"
          ></iframe>
        </div>
      </div>
    </div>
  </section>
<footer>
  <div class="container d-flex flex-wrap justify-content-between">
    <div>
      <div class="footer-logo">
        <img src="./images/tau.png" alt="Daevnt Logo" class="w-50"/>
      </div>
      <p class="footer-description">
        Pellentesque nec tempor sapien. Pellentesque vel placerat nibh. Suspendisse venenatis.
      </p>
      <form class="subscribe-form" onsubmit="event.preventDefault(); alert('Subscribed!');">
        <input type="email" placeholder="Enter Your Email Address" required />
        <button type="submit">Subscribe</button>
      </form>
    </div>

    <div class="footer-links">
      <h5>Useful Link</h5>
      <ul>
        <li><a href="#">About Events</a></li>
        <li><a href="#">Future Events</a></li>
        <li><a href="#">Top Speakers</a></li>
        <li><a href="#">Faq Pages</a></li>
        <li><a href="#">Get Ticket</a></li>
      </ul>
    </div>

    <div class="footer-contact">
      <h5>Address:</h5>
      <p>612-7 Roanoke Rd, Toronto,<br />ON M3A 1E3, Canada</p>
      <p><strong>Phone:</strong> +1-416-8241228</p>
      <p><strong>Email:</strong> info@email.com</p>
    </div>
  </div>

  <button class="back-to-top" aria-label="Back to top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
    &uarr;
  </button>
</footer>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- <script>

    const ticketPrices = { regular: 5000, vip: 50000 };
    const ticketTypeEl = document.getElementById("ticketType");
    const quantityEl = document.getElementById("quantity");
    const priceBox = document.getElementById("priceBox");

    // Update displayed price dynamically
    function updatePrice() {
      let type = ticketTypeEl.value;
      let qty = parseInt(quantityEl.value || 1);
      if (type && ticketPrices[type]) {
        let total = ticketPrices[type] * qty;
        priceBox.textContent = `Total Price: ‚Ç¶${total}`;
      } else {
        priceBox.textContent = "Total Price: ‚Ç¶0";
      }
    }
    ticketTypeEl.addEventListener("change", updatePrice);
    quantityEl.addEventListener("input", updatePrice);

    document.getElementById("ticketForm").addEventListener("submit", async function(e){
      e.preventDefault();

      let ticketType = ticketTypeEl.value;
      let quantity = parseInt(quantityEl.value);
      let firstname = document.getElementById("firstname").value;
      let lastname = document.getElementById("lastname").value;
    //   let department = document.getElementById("department").value;
      let email = document.getElementById("email").value;
      let phone = document.getElementById("phone").value;

      try {
        // 1Ô∏è‚É£ Create Ticket

        let ticketRes = await fetch("http://localhost:8080/api/create-ticket/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ticket_type: ticketType,
            quantity: quantity,
            totalPrice: ticketPrices[ticketType] * quantity
          })
        });

        let ticketData = await ticketRes.json();
        if (ticketData.status !== "success") {
          alert("Error creating ticket: " + JSON.stringify(ticketData));
          return;
        }
        let ticketId = ticketData.ticket_id;   // must be returned from backend
        let totalPrice = ticketData.total_price;

        // 2Ô∏è‚É£ Add Contact
        let contactRes = await fetch(`https://ticketing-2x61.onrender.com/api/ticket/${ticketId}/contact/`, {

          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            firstname,
            lastname,
            // department,
            email,
            phone
          })
        });

        let contactData = await contactRes.json();
        if (!contactData || contactData.error) {
          alert("Error saving contact: " + JSON.stringify(contactData));
          return;
        }

        // 3Ô∏è‚É£ Initialize Payment
        let payRes = await fetch(`https://ticketing-2x61.onrender.com/api/ticket/initialize-payment/`, {
        // let payRes = await fetch(`http://localhost:8080/api/ticket/${ticketId}/initialize-payment/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ticket_id: ticketId,
            // local_reference: payData ? payData.reference : null,
            email: email
          })
        });

        let payData = await payRes.json();
        console.log(payData);
        if (payData.error) {
          alert("Error initializing payment: " + payData.error);
          console.error(payData);
          console.log("Payment initialization failed");
          return;
        }

        // 4Ô∏è‚É£ Open Monnify Payment
       MonnifySDK.initialize({
          amount: Number(payData.amount), // ensure number
          currency: "NGN",
          reference: payData.reference, // unique per transaction
          customerFullName: payData.customerName,
          customerEmail: payData.customerEmail,
          customerPhone: payData.customerPhone || "08000000000",
          apiKey: "MK_TEST_VZ3SL4J3A5",   // must be PUBLIC KEY
          contractCode: "4216477966",
          paymentDescription: "Event Ticket Purchase",
          isTestMode: true,
          metadata: {
            ticket_id: ticketId,
            ticketType: ticketType,
            quantity: quantity,
          },
          onLoadStart: () => {
            console.log("Monnify popup loading...");
          },
          onLoadComplete: () => {
            console.log("Monnify popup loaded.");
          },
          onComplete: function(response) {
            console.log("Transaction completed: ", response);
            // here response.paymentReference is the correct one to use
          },
          onClose: function(data) {
            console.log("Payment closed: ", data);
          }
        });


      } catch (err) {
        console.error(err);
        alert("Something went wrong. Check console.");
      }
    });
  </script> -->


<script>


  function showTicketDescription() {
    const ticketType = document.getElementById("ticketType").value;
    const descriptionDiv = document.getElementById("ticketDescription");

    let description = "";

    switch(ticketType) {
      case "standard":
        description = `The entry point for students and community members. <br>
          Admission to all talks <br>
          Access to networking sessions <br>
          Complimentary light refreshments`;
        break;
      case "gold":
          description = `A more comfortable experience with a few extras.<br>
          Everything in Standard<br>
          Reserved seating for better visibility<br>
          Lunch served during intermission<br>
          TEDxTAU-themed stationery`;
        break;
      case "premium":
          description = `For those who want to experience TEDxTAU with more exclusivity.<br>
          All Gold benefits<br>
          TEDxTAU-branded souvenirs<br>
          Priority seating near the stage<br>`;
        break;
      case "vip":
          description = `An all-access pass with the highest level of recognition.<br>
          All Premium benefits<br>
          Complimentary snacks throughout the event<br>
          Official TEDxTAU branded T-shirt <br>
          Exclusive photo opportunities and private networking with speakers/curators`;
        break;
      
      default:
        description = "";
    }

    descriptionDiv.innerHTML = description;
  }




    // ---------- CONFIG ----------
    const BASE_URL = "https://ticketing-2x61.onrender.com"; // update if needed
    const MONNIFY_API_KEY = "MK_TEST_VZ3SL4J3A5"; // replace with your API key
    const MONNIFY_CONTRACT = "4216477966"; // replace with your contract code
    // ----------------------------

    const ticketPrices = { standard: 5000, gold: 10000, premium: 15000, vip: 30000 };
    const ticketTypeEl = document.getElementById("ticketType");
    const quantityEl = document.getElementById("quantity");
    const priceBox = document.getElementById("priceBox");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById("ticketForm");

    // Format NGN nicely
    const formatNaira = n => new Intl.NumberFormat('en-NG').format(n || 0);

    // update displayed price
    function updatePrice() {
      const type = ticketTypeEl.value;
      const qty = Math.max(1, parseInt(quantityEl.value || 1));
      if (type && ticketPrices[type]) {
        const total = ticketPrices[type] * qty;
        priceBox.textContent = `Total Price: ‚Ç¶${formatNaira(total)}`;
      } else {
        priceBox.textContent = "Total Price: ‚Ç¶0";
      }
    }

    ticketTypeEl.addEventListener("change", updatePrice);
    quantityEl.addEventListener("input", updatePrice);
    // run once on load
    updatePrice();

    // Helper to safe-parse JSON or return text
    async function safeParseResponse(res) {
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        return { __raw: text };
      }
    }

    // Helper to show messages to user
    function showMessage(text, isError = false) {
      messageEl.textContent = text;
      messageEl.style.color = isError ? "#C62828" : "#2E7D32";
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      showMessage("");
      // basic client validation
      if (!ticketTypeEl.value) { showMessage("Please select a ticket type.", true); ticketTypeEl.focus(); return; }
      if (!quantityEl.value || parseInt(quantityEl.value) < 1) { showMessage("Quantity must be at least 1.", true); quantityEl.focus(); return; }
      if (!document.getElementById("firstname").value.trim()) { showMessage("First name is required.", true); return; }
      if (!document.getElementById("lastname").value.trim()) { showMessage("Last name is required.", true); return; }
      if (!document.getElementById("email").value.trim()) { showMessage("Email is required.", true); return; }
      if (!document.getElementById("phone").value.trim()) { showMessage("Phone is required.", true); return; }

      // disable UI
      submitBtn.disabled = true;
      submitBtn.textContent = "Processing...";

      // gather values
      const ticketType = ticketTypeEl.value;
      const quantity = Math.max(1, parseInt(quantityEl.value || 1));
      const firstname = document.getElementById("firstname").value.trim();
      const lastname = document.getElementById("lastname").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const computedTotal = (ticketPrices[ticketType] || 0) * quantity;

      try {
        console.log("Creating ticket...", { ticketType, quantity, computedTotal });

        // 1) Create ticket (send both possible field names to be tolerant)
        const createRes = await fetch(`${BASE_URL}/api/create-ticket/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ticket_type: ticketType,
            quantity,
            totalPrice: computedTotal,
            total_price: computedTotal
          })
        });

        if (!createRes.ok) {
          const errBody = await safeParseResponse(createRes);
          console.error("Create ticket non-OK response:", createRes.status, errBody);
          throw new Error(`Create-ticket failed (status ${createRes.status}): ${JSON.stringify(errBody)}`);
        }

        const ticketData = await safeParseResponse(createRes);
        console.log("Create ticket response:", ticketData);

        // Accept common success shapes: { status: 'success', ticket_id: 1 } OR { success: true, ticket_id: ... }
        const createdOk =
          (ticketData.status && ticketData.status.toLowerCase() === "success") ||
          ticketData.success === true ||
          ticketData.ticket_id;

        if (!createdOk) {
          throw new Error("Ticket creation returned unexpected payload: " + JSON.stringify(ticketData));
        }

        const ticketId = ticketData.ticket_id || ticketData.id || ticketData.data?.ticket_id;
        if (!ticketId) throw new Error("No ticket id returned by create-ticket endpoint.");

        // 2) Save contact
        console.log("Saving contact for ticket:", ticketId);
        const contactRes = await fetch(`${BASE_URL}/api/ticket/${ticketId}/contact/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ firstname, lastname, email, phone })
        });

        if (!contactRes.ok) {
          const errBody = await safeParseResponse(contactRes);
          console.error("Contact non-OK response:", contactRes.status, errBody);
          throw new Error(`Contact saving failed (status ${contactRes.status}): ${JSON.stringify(errBody)}`);
        }
        const contactData = await safeParseResponse(contactRes);
        console.log("Contact response:", contactData);
        if (contactData.error || contactData.success === false) {
          throw new Error("Contact saving returned error: " + JSON.stringify(contactData));
        }

        // 3) Initialize payment
        console.log("Initializing payment for ticket:", ticketId);
        // Send the ticket id as body; your backend may expect a different path - this is tolerant
        const initRes = await fetch(`${BASE_URL}/api/ticket/initialize-payment/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ticket_id: ticketId, email })
        });

        if (!initRes.ok) {
          const errBody = await safeParseResponse(initRes);
          console.error("Init payment non-OK response:", initRes.status, errBody);
          throw new Error(`Payment initialization failed (status ${initRes.status}): ${JSON.stringify(errBody)}`);
        }

        const payData = await safeParseResponse(initRes);
        console.log("Payment init response:", payData);

        // Validate necessary fields exist
        const amount = payData.amount || payData.data?.amount || computedTotal;
        const reference = payData.reference || payData.data?.reference || payData.paymentReference || payData.transactionReference;
        const customerName = payData.customerName || `${firstname} ${lastname}`;
        const customerEmail = payData.customerEmail || email;
        const customerPhone = payData.customerPhone || phone;
        const paymentDescription = payData.paymentDescription || "Event Ticket Purchase";
        const redirectUrl = payData.redirectUrl || payData.data?.redirectUrl || BASE_URL;

        if (!amount || !reference) {
          throw new Error("Payment initialization response missing `amount` or `reference`: " + JSON.stringify(payData));
        }

        showMessage("Opening payment widget...");

        // 4) Open Monnify widget
        if (typeof MonnifySDK === "undefined") {
          throw new Error("Monnify SDK is not loaded. Check network / CSP and that https://sdk.monnify.com/plugin/monnify.js is reachable.");
        }

        // Initialize Monnify - this should open the widget
        // MonnifySDK.initialize({
        //   amount: Number(amount),
        //   currency: "NGN",
        //   reference: reference,
        //   customerFullName: customerName,
        //   customerEmail: customerEmail,
        //   customerPhone: customerPhone,
        //   apiKey: MONNIFY_API_KEY,
        //   contractCode: MONNIFY_CONTRACT || "4216477966",
        //   paymentDescription: paymentDescription,
        //   isTestMode: true,
        //   redirectUrl: redirectUrl,
        //   metadata: { ticket_id: ticketId, ticketType, quantity },
        //   onLoadStart: () => {
        //     console.log("Monnify popup loading...");
        //   },
        //   onLoadComplete: () => {
        //     console.log("Monnify popup loaded.");
        //   },
        //   onComplete: function (response) {
        //     console.log("Monnify onComplete:", response);
        //     // The SDK sometimes returns a 'status' or paymentReference; check common shapes
        //     const status = response.status || response.paymentStatus || response.txnStatus;
        //     if (String(status).toUpperCase() === "PAID" || response.paymentReference || response.transactionReference) {
        //       alert("‚úÖ Payment Successful! Ticket will be emailed.");
        //       showMessage("Payment successful. Thank you!");
        //       // Optionally redirect to success page here
        //     } else {
        //       alert("‚ùå Payment Failed or Cancelled");
        //       showMessage("Payment was not successful.", true);
        //     }
        //     // re-enable button after completion
        //     submitBtn.disabled = false;
        //     submitBtn.textContent = "Proceed to Pay";
        //   },
        //   onClose: function () {
        //     console.log("Monnify widget closed by user.");
        //     showMessage("Payment widget closed.", true);
        //     submitBtn.disabled = false;
        //     submitBtn.textContent = "Proceed to Pay";
        //   }
        // });
 MonnifySDK.initialize({
          amount: Number(payData.amount), // ensure number
          currency: "NGN",
          reference: payData.reference, // unique per transaction
          customerFullName: payData.customerName,
          customerEmail: payData.customerEmail,
          customerPhone: payData.customerPhone || "08000000000",
          apiKey: "MK_TEST_VZ3SL4J3A5",   // must be PUBLIC KEY
          contractCode: "4216477966",
          paymentDescription: "Event Ticket Purchase",
          isTestMode: true,
          metadata: {
            ticket_id: ticketId,
            ticketType: ticketType,
            quantity: quantity,
          },
          onLoadStart: () => {
            console.log("Monnify popup loading...");
          },
          onLoadComplete: () => {
            console.log("Monnify popup loaded.");
          },
          onComplete: (res) => {
            if (res.paymentStatus === "PAID") {
              // alert("‚úÖ Payment Successful! Ticket will be emailed.");
              console.log("Payment Successful! Ticket will be emailed.");
              // window.location.href = `http://localhost:5500/gpt/payment_success.html`;
              // window.location.href = `http://localhost:5500/gpt/payment_success.html?ticketId=${ticketId}&paymentReference=${paymentReference}`;
              // window.location.href = `https://localhost:5501/ery-Do-Not-Delete/payment_success.html?ticketId=${ticketId}&paymentReference=${customerName}`;
              window.location.href = `https://ery-001.github.io/tedXtau-payment_success/payment_success.html?ticketId=${ticketId}&paymentReference=${customerName}`;
              window.location.href = `${BASE_URL}/api/ticket/${ticketId}/ticket/send-ticket/`;


            } else {
              alert("‚ùå Payment Failed or Cancelled");
            }
            // if (res.paymentStatus === "PAID") {
            //   alert("‚úÖ Payment Successful! Ticket will be emailed.");
            //   // window.location.href = `http://localhost:8080/api/ticket/${ticketId}/ticket/send-ticket/`;
            // } else {
            //   alert("‚ùå Payment Failed or Cancelled");
            // }
          },
          onClose: function(data) {
            console.log("Payment closed: ", data);
          }
        });

      } catch (err) {
        console.error("Error flow:", err);
        showMessage("Something went wrong. Check console for details.", true);
        alert("Something went wrong. See console (F12) for details.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Proceed to Pay";
      }
    });
  </script>
</body>
</html>
